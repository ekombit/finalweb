<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechStore | Products</title>
  <link rel="icon" type="image/png" href="favicon.jpg">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
/* –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–≤–æ–∏—Ö —Ä—É—á–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ (All Products) */
#productList .card {
  background-color: #0d1117;
  border: none;
  border-radius: 10px;
  overflow: hidden;
  height: 100%;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

#productList .card:hover {
  transform: translateY(-5px);
  box-shadow: 0 4px 20px rgba(0, 170, 255, 0.3);
}

#productList .card img {
  width: 100%;
  height: 200px; /* —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É */
  object-fit: cover; /* –ø–æ–¥—Ä–µ–∑–∞–µ—Ç —Ñ–æ—Ç–æ, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
  border-bottom: 1px solid #1f1f1f;
}

#productList .card-body {
  padding: 15px;
  flex-grow: 1;
}

#productList .card-title {
  font-size: 1.1rem;
  color: #00aaff;
  min-height: 48px; /* –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤—ã—Å–æ—Ç–µ */
}

#productList .btn-custom {
  background-color: #00aaff;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  transition: background 0.3s;
}

#productList .btn-custom:hover {
  background-color: #0088cc;
}
</style>


  <style>
    
    
    /* Default Dark Theme */
body {
  background-color: #0a0a0a;
  color: white;
}

/* Light Theme */
body.light-mode {
  background-color: #f6f6f6;
  color: #111;
}

body.light-mode .navbar {
  background-color: #e9ecef;
}

body.light-mode .navbar-brand {
  color: #0077cc;
}

body.light-mode .nav-link {
  color: #111 !important;
}

body.light-mode .nav-link:hover {
  color: #0077cc !important;
}

body.light-mode .card {
  background-color: #fff;
  border: 1px solid #ddd;
}

body.light-mode .card-title {
  color: #0077cc;
}

body.light-mode footer {
  background-color: #e9ecef;
  color: #333;
}

body.light-mode .btn-custom {
  background-color: #0077cc;
  color: white;
}

body.light-mode .btn-custom:hover {
  background-color: #005fa3;
}

    body {
      background-color: #0a0a0a;
      color: white;
      font-family: 'Poppins', sans-serif;
    }

    .navbar {
      background-color: #0d1117;
    }

    .navbar-brand {
      color: #00aaff;
      font-weight: 700;
      font-size: 1.5rem;
    }

    .navbar-brand:hover {
      color: #ffffff;
    }

    .nav-link {
      color: #ffffff;
      margin-right: 15px;
    }

    .nav-link:hover {
      color: #00aaff;
    }

    .search-bar {
      background-color: #0d1117;
      border: 1px solid #1f1f1f;
      color: white;
      border-radius: 8px;
      padding: 10px 15px;
      width: 100%;
    }
    

    .card {
      background-color: #111;
      border: 1px solid #1f1f1f;
      border-radius: 10px;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 0 15px #00aaff55;
    }

    .card-title {
      color: #00aaff;
    }

    .btn-custom {
      background-color: #00aaff;
      color: white;
      border: none;
    }

    .btn-custom:hover {
      background-color: #0088cc;
    }

    footer {
      background-color: #0d1117;
      color: #aaa;
      text-align: center;
      padding: 20px 0;
      margin-top: 40px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="index.html">TechStore</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="products.html">Products</a></li>
        <li class="nav-item"><a class="nav-link" href="cart.html">Cart</a></li>
        <li class="nav-item"><a class="nav-link" href="checkout.html">Checkout</a></li>
        <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
      </ul>

      <!-- –ö–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
      <div class="ms-3">
        <div class="ms-3 d-flex align-items-center gap-2" id="authButtons">
          <!-- guest -->
          <a href="login.html" class="btn btn-outline-light btn-sm guest-only">Log In</a>
          <a href="signup.html" class="btn btn-custom btn-sm guest-only">Sign Up</a>
        
          <!-- logged in -->
          <a href="profile.html" class="btn btn-outline-info btn-sm auth-only" style="display:none;">Profile</a>
          <button id="logoutBtnNav" class="btn btn-outline-danger btn-sm auth-only" style="display:none;">Log Out</button>
        </div>
        
        <button id="themeToggle" class="btn btn-outline-light btn-sm ms-3">üåô Dark Mode</button>
      </div>
    </div>
  </div>
</nav>


  <!-- Title -->
  <div class="container mt-4">
    <h2 class="text-center mb-4" style="color:#00aaff;">All Products</h2>

    <!-- Search Bar -->
    <div class="mb-4">
      <input type="text" id="searchInput" class="search-bar" placeholder="Search products...">
    </div>

    <!-- Add Product (saves to MongoDB) + Import from external API (admin) -->
    <div class="card p-3 mb-4" id="adminPanel">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 style="color:#00aaff;" class="mb-0">Add Product</h5>
    <button id="importBtn" class="btn btn-outline-info btn-sm" style="display:none;">
      Import Smartphones
    </button>
  </div>
  <div class="row g-2">
    <div class="col-md-4">
      <input id="pTitle" class="form-control" placeholder="Title (e.g. MacBook Air M3)">
    </div>
    <div class="col-md-2">
      <input id="pPrice" type="number" class="form-control" placeholder="Price">
    </div>
    <div class="col-md-2">
      <input id="pStock" type="number" class="form-control" placeholder="Stock">
    </div>
    <div class="col-md-2">
      <input id="pBrand" class="form-control" placeholder="Brand">
    </div>
    <div class="col-md-2">
      <input id="pCategory" class="form-control" placeholder="Category">
    </div>
    <div class="col-md-8">
      <input id="pImage" class="form-control" placeholder="Image URL (optional)">
    </div>
    <div class="col-md-4 d-grid">
      <button id="addProductBtn" class="btn btn-custom">Add to MongoDB</button>
    </div>
  </div>
  <div id="addMsg" class="mt-2" style="display:none;"></div>
  <div id="importMsg" class="mt-1" style="display:none; font-size:0.9rem;"></div>
  </div>


  
    <!-- Products Grid (rendered from MongoDB) -->
    <div class="row g-4" id="productList"></div>

  <!-- Footer -->
  <footer>
    ¬© 2025 TechStore | All Rights Reserved.
  </footer>

  <script src="js/theme.js"></script>
  <script>
$(document).ready(function () {
  // ===== AUTH =====
  const token = localStorage.getItem("token");
  if (!token) {
    window.location.href = "login.html";
    return;
  }

  // ===== CART (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–≤–æ—é –ª–æ–≥–∏–∫—É) =====
  function getCart() { return JSON.parse(localStorage.getItem("cart")) || []; }
  function saveCart(cart) { localStorage.setItem("cart", JSON.stringify(cart)); }
  function updateCartCount() {
    const cart = getCart();
    let count = 0;
    cart.forEach(i => count += i.quantity);
    if ($("#cartCount").length) $("#cartCount").text(count);
  }
  $(document).on("click", ".add-to-cart", function() {
    const productCard = $(this).closest(".product-card");
    const name = productCard.data("name");
    const price = parseFloat(productCard.data("price"));

    if (!name || isNaN(price)) return alert("Product data missing");

    const cart = getCart();
    const existing = cart.find(item => item.name === name);
    if (existing) existing.quantity = (existing.quantity || 0) + 1;
    else cart.push({ name, price, quantity: 1 });

    saveCart(cart);
    updateCartCount();
    alert(name + " added to cart!");
  });
  updateCartCount();

  // ===== PRODUCTS API =====
  async function api(url, options = {}) {
    const res = await fetch(url, {
      ...options,
      headers: {
        ...(options.headers || {}),
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      }
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.message || "Request failed");
    return data;
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function renderProducts(products) {
    const container = $("#productList");
    container.empty();

    if (!products.length) {
      container.html("<p class='text-center text-muted'>No products in MongoDB yet. Add one above üëÜ</p>");
      return;
    }

    products.forEach(p => {
      const img = (p.images && p.images.length) ? p.images[0] : "https://via.placeholder.com/400x250?text=No+Image";
      const price = typeof p.price === "number" ? p.price : 0;
      const role = localStorage.getItem("role") || "user";


      container.append(`
        <div class="col-md-3 product-card" data-name="${escapeHtml(p.title)}" data-price="${price}">
          <div class="card text-center">
            <img src="${img}" class="card-img-top" alt="${escapeHtml(p.title)}">
            <div class="card-body">
              <h5 class="card-title">${escapeHtml(p.title)}</h5>
              <p>$${price}</p>
              <div class="d-grid gap-2">
                <button class="btn btn-custom add-to-cart">Add to Cart</button>
                ${role === "admin" ? `<button class="btn btn-outline-danger btn-sm delete-product" data-id="${p._id}">Delete</button>` : ""}

              </div>
            </div>
          </div>
        </div>
      `);
    });
  }

  let cachedProducts = [];

  async function loadProducts() {
    try {
      const products = await api("/api/products", { method: "GET" });
      cachedProducts = products;
      renderProducts(products);

      // –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏ –∫–Ω–æ–ø–∫—É –∏–º–ø–æ—Ä—Ç–∞ –ø–æ —Ä–æ–ª–∏
      const role = localStorage.getItem("role") || "user";
      if (role === "admin") {
        $("#adminPanel").show();
        $("#importBtn").show();
      } else {
        $("#adminPanel").hide();
      }
    } catch (e) {
      console.error(e);
      // –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω —É–º–µ—Ä
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "login.html";
    }
  }

  // ===== ADD PRODUCT (MongoDB) =====
  $("#addProductBtn").on("click", async function () {
    const title = $("#pTitle").val().trim();
    const price = Number($("#pPrice").val());
    const stock = Number($("#pStock").val() || 0);
    const brand = $("#pBrand").val().trim();
    const category = $("#pCategory").val().trim();
    const image = $("#pImage").val().trim();

    if (!title || !Number.isFinite(price)) {
      return showMsg("addMsg", " Title and valid price required", false);
    }

    const body = {
      title,
      price,
      stock,
      brand,
      category,
      images: image ? [image] : []
    };

    try {
      await api("/api/products", { method: "POST", body: JSON.stringify(body) });
      showMsg("addMsg", " Product added to MongoDB", true);

      // clear inputs
      $("#pTitle,#pPrice,#pStock,#pBrand,#pCategory,#pImage").val("");

      await loadProducts();
    } catch (e) {
      showMsg("addMsg", " " + e.message, false);
    }
  });

  function showMsg(id, text, ok) {
    const el = $("#" + id);
    el.text(text).show();
    el.css("color", ok ? "#22c55e" : "#ff5555");
    setTimeout(() => el.fadeOut(), 2500);
  }

  // ===== IMPORT FROM EXTERNAL API (DummyJSON) =====
  $("#importBtn").on("click", async function () {
    const role = localStorage.getItem("role") || "user";
    if (role !== "admin") {
      return showMsg("importMsg", "Only admin can import products", false);
    }

    // —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (–ø–æ title, –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
    const existingTitles = new Set(
      (cachedProducts || []).map(p => (p.title || "").toLowerCase())
    );

    try {
      showMsg("importMsg", "Importing from external API...", true);

      const res = await fetch("https://dummyjson.com/products/category/smartphones");
      const data = await res.json();
      const apiProducts = Array.isArray(data.products) ? data.products : [];

      // –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –ø–æ title
      const toImport = apiProducts.filter(p => {
        const t = (p.title || "").toLowerCase();
        return t && !existingTitles.has(t);
      });

      if (!toImport.length) {
        showMsg("importMsg", "No new smartphones to import", true);
        return;
      }

      // –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ /api/products
      const bodies = toImport.map(p => ({
        title: p.title,
        price: Number(p.price) || 0,
        stock: Number(p.stock ?? 10),
        brand: p.brand || "Unknown",
        category: p.category || "smartphones",
        images: p.thumbnail ? [p.thumbnail] : []
      }));

      for (const body of bodies) {
        await api("/api/products", {
          method: "POST",
          body: JSON.stringify(body)
        });
      }

      showMsg("importMsg", `Imported ${bodies.length} products from external API`, true);
      await loadProducts();
    } catch (e) {
      console.error(e);
      showMsg("importMsg", "Import failed: " + e.message, false);
    }
  });

  // ===== DELETE PRODUCT =====
  $(document).on("click", ".delete-product", async function () {
    const id = $(this).data("id");
    if (!confirm("Delete this product?")) return;

    try {
      await api("/api/products/" + id, { method: "DELETE" });
      await loadProducts();
    } catch (e) {
      alert("Delete failed: " + e.message);
    }
  });

  // ===== SEARCH (filters rendered cards) =====
  $("#searchInput").on("keyup", function () {
    const value = $(this).val().toLowerCase();
    const filtered = cachedProducts.filter(p => (p.title || "").toLowerCase().includes(value));
    renderProducts(filtered);
  });

  // INIT
  loadProducts();
});
  </script>
<script>
  (function () {
    function isLoggedIn() {
      return !!localStorage.getItem("token");
    }
  
    function updateAuthUI() {
      const logged = isLoggedIn();
      document.querySelectorAll(".guest-only").forEach(el => {
        el.style.display = logged ? "none" : "";
      });
      document.querySelectorAll(".auth-only").forEach(el => {
        el.style.display = logged ? "" : "none";
      });
    }
  
    // logout button in navbar
    const logoutBtn = document.getElementById("logoutBtnNav");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        localStorage.removeItem("role");
        // optional: clear session flags if used anywhere
        sessionStorage.removeItem("loggedIn");
        window.location.href = "index.html";
      });
    }
  
    updateAuthUI();
  })();
  </script>
  

</body>
</html>
